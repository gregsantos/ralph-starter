# Progress for branch: spec-mode
# Started: 2026-02-04 16:04:20

## Iteration 1 - T-001: Add spec mode argument parsing

**Completed:** Task 1.1 (T-001) - Add spec mode argument parsing

**Changes:**
- Added "spec" to preset case statement in ralph.sh (line ~1137)
- Updated show_help() with spec mode in Presets section
- Added spec mode example in Examples section
- Updated Defaults section to include spec mode

**Files modified:**
- ralph.sh

**Decisions:**
- Spec mode uses same default model (opus) as other presets via existing preset logic
- Prompt file dynamically resolved to prompts/PROMPT_spec.md via existing PRESET_NAME mechanism
- No new flags added yet (that's T-002/T-003)

**Verification:**
- `./ralph.sh --help` shows spec mode in presets
- `./ralph.sh spec --dry-run` recognizes spec mode (fails on missing PROMPT_spec.md as expected - that's T-004)
- shellcheck passes (no new warnings introduced)

**Next:** T-002, T-003, T-004 can now proceed (all depend on T-001)

## Iteration 2 - T-002: Add spec mode input flags

**Completed:** Task 1.2 (T-002) - Add spec mode input flags

**Changes:**
- Added spec mode variables: FROM_PRODUCT, SPEC_OUTPUT_FILE, SPEC_FORCE_OVERWRITE, SPEC_INPUT_TYPE, SPEC_INPUT_CONTENT, CLI_INLINE_PROMPT, CLI_FILE_PATH
- Added argument parsing for --from-product, -o/--spec-output, --force flags
- Added CLI_SPEC_OUTPUT_SET tracking variable
- Added "Spec Mode Options" section to show_help() with documentation for all spec mode flags
- Added spec mode examples to Examples section
- Added spec mode input validation section that:
  - Counts input sources from -p, -f, and --from-product
  - Requires exactly one input source for spec mode
  - Validates input file exists for -f
  - Validates product artifacts exist for --from-product
  - Checks output file existence (unless --force)
  - Creates specs/ directory if needed

**Files modified:**
- ralph.sh

**Decisions:**
- Used CLI_INLINE_PROMPT and CLI_FILE_PATH to preserve -p/-f values separately from PROMPT_SOURCE, since the 'spec' preset overwrites PROMPT_SOURCE
- Spec mode resets PROMPT_SOURCE to "preset" after capturing input, ensuring PROMPT_spec.md is used as the prompt file
- Default output file is specs/new-spec.json (prompt will derive a better name)
- --from-product checks for any .md files in product-output/, not just specific artifacts

**Verification:**
- `./ralph.sh spec` errors with "requires an input source"
- `./ralph.sh spec -p "X" -f ./README.md` errors with "accepts only one input source"
- `./ralph.sh spec -p "X" --from-product` errors with "accepts only one input source"
- `./ralph.sh spec --from-product` errors about missing product artifacts (expected)
- `./ralph.sh spec -f ./nonexistent.md` errors about file not found
- `./ralph.sh spec -p "Dark mode"` passes input validation (fails on missing PROMPT_spec.md as expected - T-004)
- `./ralph.sh --help` shows Spec Mode Options section
- shellcheck passes (no new errors)

**Next:** T-003 (output flag - mostly done), T-004 (PROMPT_spec.md), then T-005 (wire it all together)

## Iteration 3 - T-003: Add spec mode output flag

**Completed:** Task 1.3 (T-003) - Add spec mode output flag

**Changes:**
- Verified all T-003 functionality was implemented in T-002 iteration
- `-o/--spec-output PATH` specifies custom output location
- Default output: `specs/new-spec.json` (spec prompt derives better name)
- `mkdir -p specs/` creates directory if needed
- `--force` flag bypasses overwrite protection
- Warning and exit if output file exists without `--force`

**Files modified:**
- plans/unified-spec-workflow_PLAN.md (marked items complete)
- specs/unified-spec-workflow.json (updated T-003 status and notes)
- progress.txt (this entry)

**Verification:**
- `./ralph.sh spec -o ./specs/test.json -p "Test"` reaches prompt validation (missing PROMPT_spec.md - expected)
- `./ralph.sh spec -o ./specs/unified-spec-workflow.json -p "Test"` warns about existing file
- `./ralph.sh spec -o ./specs/unified-spec-workflow.json --force -p "Test"` bypasses warning
- shellcheck passes (existing warnings unrelated to T-003)

**Next:** T-004 (PROMPT_spec.md) - create the spec mode prompt file

## Iteration 4 - T-004: Create PROMPT_spec.md

**Completed:** Task 1.4 (T-004) - Create PROMPT_spec.md

**Changes:**
- Created prompts/PROMPT_spec.md with full spec mode instructions

**Key sections in the prompt:**
1. Context section with template variables: `{{INPUT_SOURCE}}`, `{{OUTPUT_FILE}}`, `{{PROGRESS_FILE}}`, `{{SOURCE_DIR}}`
2. Critical instruction to read `.claude/skills/writing-ralph-specs/SKILL.md` FIRST
3. Input handling for all three sources:
   - Inline prompt (`-p`)
   - File input (`-f`)
   - Product artifacts (`--from-product`) with guidance on which files to prioritize
4. Codebase research phase before spec generation
5. Task design guidelines with granularity recommendations
6. JSON spec output format with tasks array example showing all fields
7. Validation checklist for spec quality
8. Completion protocol with pre-completion checklist

**Files modified:**
- prompts/PROMPT_spec.md (new file)
- plans/unified-spec-workflow_PLAN.md (marked items complete)
- specs/unified-spec-workflow.json (updated T-004 status and notes)

**Decisions:**
- Followed pattern from PROMPT_plan.md and PROMPT_build.md for consistent structure
- Made skill reading a critical first-action requirement (not just a suggestion)
- Included task granularity guidelines (1-2 iterations per task)
- Added validation checklist to catch issues before completion
- Spec mode typically completes in 1-3 iterations

**Verification:**
- File exists at prompts/PROMPT_spec.md
- All template variables present: INPUT_SOURCE, OUTPUT_FILE, PROGRESS_FILE, SOURCE_DIR
- Skill read instruction in "Critical" section
- Tasks-based JSON format documented with example

**Next:** T-005 (Wire spec mode in main loop) - now that T-002, T-003, T-004 are complete

## Iteration 5 - T-005: Wire spec mode in main loop

**Completed:** Task 1.5 (T-005) - Wire spec mode in main loop

**Changes:**
- Added SPEC_MODE_INPUT_SOURCE and SPEC_MODE_OUTPUT_FILE variables to ralph.sh
- Added spec mode variable population section (after product mode defaults)
- Updated substitute_template() function to include {{INPUT_SOURCE}} and {{OUTPUT_FILE}}
- INPUT_SOURCE populated based on input type:
  - prompt: uses inline content directly
  - file: reads and includes file contents via `cat`
  - product: concatenates product artifacts in priority order

**Product artifact priority order:**
1. 7_prd.md (PRD - primary source)
2. 9_technical_requirements.md
3. 4_personas.md
4. 6_user_journey_map.md
5. 8_feature_specifications.md
- Falls back to all .md files if none of the priority files exist

**Files modified:**
- ralph.sh (substitute_template function, spec mode variable section)
- plans/unified-spec-workflow_PLAN.md (marked T-005 items complete)
- specs/unified-spec-workflow.json (updated T-005 status, passes, notes)
- progress.txt (this entry)

**Decisions:**
- Used SPEC_MODE_* prefix for template variables to avoid name collisions
- PROMPT_FILE was already correctly set by existing preset logic at line 1379
- Product artifacts concatenated with "=== filename ===" headers for clarity
- Priority order for product files based on typical importance for spec generation

**Verification:**
- `./ralph.sh spec -p "Add dark mode" --dry-run` runs successfully
- `./ralph.sh spec -p "Add dark mode" -v --dry-run` shows verbose config
- `./ralph.sh --help` shows spec mode documentation
- shellcheck passes (no new warnings in added code)
- Template substitution logic verified with inline bash test

**Milestone M1 (Spec Mode MVP) Complete:**
Tasks T-001, T-002, T-003, T-004, T-005 are all complete.
Spec mode can now generate specs from user input, file, or product artifacts.

**Next:** T-006 (Define enhanced spec schema with tasks) - Phase 2 begins

## Iteration 6 - T-006: Define enhanced spec schema with tasks

**Completed:** Task 2.1 (T-006) - Define enhanced spec schema with tasks

**Changes:**
- Updated .claude/skills/writing-ralph-specs/SKILL.md with comprehensive tasks array schema
- Added "Tasks Array Schema (Recommended)" section with:
  - Task Fields table documenting all fields: id, title, description, acceptanceCriteria, dependsOn, status, passes, effort, notes, phase
  - Type information for each field (string, string[], boolean)
  - Required vs optional field designation
- Added "Status Values" section: pending, in_progress, complete, blocked
- Added "Example Spec with Tasks" showing full task structure
- Added "Legacy: userStories Array" section for backward compatibility
- Updated workflow section to show: spec mode → (optional) plan mode → build mode
- Updated tips section with tasks terminology (atomic tasks vs atomic stories)
- Changed reference from ralph-improvements.json to unified-spec-workflow.json

**Files modified:**
- .claude/skills/writing-ralph-specs/SKILL.md

**Decisions:**
- Documented schema directly in the writing-ralph-specs skill (not a separate schema file) since Claude reads this skill when creating specs
- Made tasks the recommended format, userStories as legacy
- Included status field alongside passes for workflow visibility (status = human-readable state, passes = boolean for automation)
- dependsOn uses array of task IDs (not dependencies map) for simpler task-level declarations

**Verification:**
- Schema fully documented with all fields and types
- Status values defined: pending, in_progress, complete, blocked
- passes field documented as boolean for completion tracking
- dependsOn documented as array of task IDs
- Backward compatibility section explains userStories still works
- Skill file updated and ready for use

**Next:** T-007 (Update writing-ralph-specs skill) - depends on T-006

## Iteration 7 - T-007: Update writing-ralph-specs skill

**Completed:** Task 2.2 (T-007) - Update writing-ralph-specs skill

**Changes:**
- Verified all T-007 acceptance criteria were already implemented in T-006
- No code changes needed - SKILL.md already contains all required content

**Verification of acceptance criteria:**
1. ✅ `.claude/skills/writing-ralph-specs/SKILL.md updated` - File was updated in T-006
2. ✅ `tasks array documented as recommended format` - Line 10: "The `tasks` array is the recommended format"
3. ✅ `userStories marked as legacy/backward-compatible` - Lines 88-90: "Legacy: userStories Array" section
4. ✅ `Examples show tasks format with passes field` - Lines 61, 78, 159, 176 show `"passes": false`
5. ✅ `Guidance on task granularity (1-2 iterations per task)` - Line 199: "Atomic tasks: Completable in 1-2 iterations"
6. ✅ `dependsOn usage documented` - Line 202: "Use dependsOn" with example

**Files modified:**
- plans/unified-spec-workflow_PLAN.md (marked T-007 items complete)
- specs/unified-spec-workflow.json (updated T-007 status, passes, notes)
- progress.txt (this entry)

**Decisions:**
- T-006 and T-007 had overlapping scope; T-006 completed both
- No additional changes needed to SKILL.md

**Milestone M2 (Unified Spec Format) Complete:**
Tasks T-006 and T-007 are done. Tasks format is fully documented in the skill.

**Next:** T-008, T-011, T-016, T-017 can now proceed (various dependencies unblocked)

## Iteration 8 - T-008: Update build mode to find next task

**Completed:** Task 3.1 (T-008) - Update build mode to find next task

**Changes:**
- Updated prompts/PROMPT_build.md with tasks-first workflow:
  - Added "Task Source Priority" section explaining spec tasks vs plan file fallback
  - Updated "Understand Current State" with task selection algorithm:
    1. Find tasks where passes=false
    2. Filter to tasks where ALL dependsOn have passes=true
    3. Select first by ID order
  - Added instruction to set status="in_progress" before starting work
  - Updated "Document" section to update spec JSON (passes, status, notes)
  - Updated "Check If All Done" section for tasks-first approach
  - Updated "Rules" section with spec-as-source-of-truth principles

**Files modified:**
- prompts/PROMPT_build.md
- plans/unified-spec-workflow_PLAN.md (marked items complete)
- specs/unified-spec-workflow.json (updated T-008 status, passes, notes)
- progress.txt (this entry)

**Decisions:**
- Spec with tasks array is the primary source of truth; plan file is only fallback
- Task selection respects dependsOn by checking all dependencies have passes=true
- in_progress status signals to future iterations that work has begun
- When using spec tasks, plan file is NOT updated (single source of truth)

**Verification of acceptance criteria:**
1. ✅ Build mode reads spec's tasks array - Task Source Priority section
2. ✅ Finds first task where passes=false and dependsOn satisfied - Finding next task algorithm
3. ✅ Sets task status to in_progress - Section 2 "Before starting work"
4. ✅ Falls back to plan file if no tasks - Task Source Priority items 2 and 3

**Next:** T-009 (Update build mode to update task status) - depends on T-008

## Iteration 9 - T-009: Update build mode to update task status

**Completed:** Task 3.2 (T-009) - Update build mode to update task status

**Changes:**
- Updated prompts/PROMPT_build.md Section 5 (Commit):
  - Added task ID format in commit messages: `feat(T-001): description`
  - Added examples showing feat/fix/docs with task IDs
  - Updated commit steps to reference task ID placeholder
- Updated Section 4 (Document) legacy/fallback:
  - Clarified userStories.passes handling for legacy format
  - Noted that user stories don't have status field
  - Added note that tasks array doesn't exist in legacy format
- Updated Pre-Completion Checklist:
  - Made tasks-first with spec tasks checking passes and status
  - Plan file checking as legacy/fallback path
- Updated When to Signal Completion:
  - Added tasks-first criteria (passes: false check)
  - Plan file checking as fallback

**Files modified:**
- prompts/PROMPT_build.md
- specs/unified-spec-workflow.json (T-009 status and notes)
- progress.txt (this entry)

**Decisions:**
- Commit message format uses conventional commits with task ID scope: `feat(T-XXX): description`
- Legacy userStories.passes handling preserved but explicitly documented
- Pre-completion and completion sections now prioritize tasks-first workflow

**Verification of acceptance criteria:**
1. ✅ After task completion, set passes=true and status='complete' - Lines 88-91
2. ✅ notes field updated with implementation summary - Line 91
3. ✅ No longer updates separate plan file - Line 92
4. ✅ Commit message includes task ID - Lines 117-127
5. ✅ userStories.passes still updated if using legacy format - Lines 94-99

**Next:** T-010 (Update build mode completion detection) - depends on T-009

