# Progress for branch: spec-mode
# Started: 2026-02-04 16:04:20

## Iteration 1 - T-001: Add spec mode argument parsing

**Completed:** Task 1.1 (T-001) - Add spec mode argument parsing

**Changes:**
- Added "spec" to preset case statement in ralph.sh (line ~1137)
- Updated show_help() with spec mode in Presets section
- Added spec mode example in Examples section
- Updated Defaults section to include spec mode

**Files modified:**
- ralph.sh

**Decisions:**
- Spec mode uses same default model (opus) as other presets via existing preset logic
- Prompt file dynamically resolved to prompts/PROMPT_spec.md via existing PRESET_NAME mechanism
- No new flags added yet (that's T-002/T-003)

**Verification:**
- `./ralph.sh --help` shows spec mode in presets
- `./ralph.sh spec --dry-run` recognizes spec mode (fails on missing PROMPT_spec.md as expected - that's T-004)
- shellcheck passes (no new warnings introduced)

**Next:** T-002, T-003, T-004 can now proceed (all depend on T-001)

## Iteration 2 - T-002: Add spec mode input flags

**Completed:** Task 1.2 (T-002) - Add spec mode input flags

**Changes:**
- Added spec mode variables: FROM_PRODUCT, SPEC_OUTPUT_FILE, SPEC_FORCE_OVERWRITE, SPEC_INPUT_TYPE, SPEC_INPUT_CONTENT, CLI_INLINE_PROMPT, CLI_FILE_PATH
- Added argument parsing for --from-product, -o/--spec-output, --force flags
- Added CLI_SPEC_OUTPUT_SET tracking variable
- Added "Spec Mode Options" section to show_help() with documentation for all spec mode flags
- Added spec mode examples to Examples section
- Added spec mode input validation section that:
  - Counts input sources from -p, -f, and --from-product
  - Requires exactly one input source for spec mode
  - Validates input file exists for -f
  - Validates product artifacts exist for --from-product
  - Checks output file existence (unless --force)
  - Creates specs/ directory if needed

**Files modified:**
- ralph.sh

**Decisions:**
- Used CLI_INLINE_PROMPT and CLI_FILE_PATH to preserve -p/-f values separately from PROMPT_SOURCE, since the 'spec' preset overwrites PROMPT_SOURCE
- Spec mode resets PROMPT_SOURCE to "preset" after capturing input, ensuring PROMPT_spec.md is used as the prompt file
- Default output file is specs/new-spec.json (prompt will derive a better name)
- --from-product checks for any .md files in product-output/, not just specific artifacts

**Verification:**
- `./ralph.sh spec` errors with "requires an input source"
- `./ralph.sh spec -p "X" -f ./README.md` errors with "accepts only one input source"
- `./ralph.sh spec -p "X" --from-product` errors with "accepts only one input source"
- `./ralph.sh spec --from-product` errors about missing product artifacts (expected)
- `./ralph.sh spec -f ./nonexistent.md` errors about file not found
- `./ralph.sh spec -p "Dark mode"` passes input validation (fails on missing PROMPT_spec.md as expected - T-004)
- `./ralph.sh --help` shows Spec Mode Options section
- shellcheck passes (no new errors)

**Next:** T-003 (output flag - mostly done), T-004 (PROMPT_spec.md), then T-005 (wire it all together)

## Iteration 3 - T-003: Add spec mode output flag

**Completed:** Task 1.3 (T-003) - Add spec mode output flag

**Changes:**
- Verified all T-003 functionality was implemented in T-002 iteration
- `-o/--spec-output PATH` specifies custom output location
- Default output: `specs/new-spec.json` (spec prompt derives better name)
- `mkdir -p specs/` creates directory if needed
- `--force` flag bypasses overwrite protection
- Warning and exit if output file exists without `--force`

**Files modified:**
- plans/unified-spec-workflow_PLAN.md (marked items complete)
- specs/unified-spec-workflow.json (updated T-003 status and notes)
- progress.txt (this entry)

**Verification:**
- `./ralph.sh spec -o ./specs/test.json -p "Test"` reaches prompt validation (missing PROMPT_spec.md - expected)
- `./ralph.sh spec -o ./specs/unified-spec-workflow.json -p "Test"` warns about existing file
- `./ralph.sh spec -o ./specs/unified-spec-workflow.json --force -p "Test"` bypasses warning
- shellcheck passes (existing warnings unrelated to T-003)

**Next:** T-004 (PROMPT_spec.md) - create the spec mode prompt file

## Iteration 4 - T-004: Create PROMPT_spec.md

**Completed:** Task 1.4 (T-004) - Create PROMPT_spec.md

**Changes:**
- Created prompts/PROMPT_spec.md with full spec mode instructions

**Key sections in the prompt:**
1. Context section with template variables: `{{INPUT_SOURCE}}`, `{{OUTPUT_FILE}}`, `{{PROGRESS_FILE}}`, `{{SOURCE_DIR}}`
2. Critical instruction to read `.claude/skills/writing-ralph-specs/SKILL.md` FIRST
3. Input handling for all three sources:
   - Inline prompt (`-p`)
   - File input (`-f`)
   - Product artifacts (`--from-product`) with guidance on which files to prioritize
4. Codebase research phase before spec generation
5. Task design guidelines with granularity recommendations
6. JSON spec output format with tasks array example showing all fields
7. Validation checklist for spec quality
8. Completion protocol with pre-completion checklist

**Files modified:**
- prompts/PROMPT_spec.md (new file)
- plans/unified-spec-workflow_PLAN.md (marked items complete)
- specs/unified-spec-workflow.json (updated T-004 status and notes)

**Decisions:**
- Followed pattern from PROMPT_plan.md and PROMPT_build.md for consistent structure
- Made skill reading a critical first-action requirement (not just a suggestion)
- Included task granularity guidelines (1-2 iterations per task)
- Added validation checklist to catch issues before completion
- Spec mode typically completes in 1-3 iterations

**Verification:**
- File exists at prompts/PROMPT_spec.md
- All template variables present: INPUT_SOURCE, OUTPUT_FILE, PROGRESS_FILE, SOURCE_DIR
- Skill read instruction in "Critical" section
- Tasks-based JSON format documented with example

**Next:** T-005 (Wire spec mode in main loop) - now that T-002, T-003, T-004 are complete

